name: Security – Omnixys Person Service

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  security:
    name: 🔐 Security Scans (DepCheck, Sonar, Snyk, Docker)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Check (OWASP)
        uses: dependency-check/Dependency-Check_Action@1.1.0
        with:
          project: 'Omnixys Person Service'
          path: '.'
          format: 'HTML'

      - name: Upload OWASP Report
        uses: actions/upload-artifact@v4
        with:
          name: owasp-dependency-check-report
          path: ./reports

      - name: Install Snyk CLI
        run: npm install -g snyk snyk-to-html

      - name: Authenticate Snyk
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk auth "$SNYK_TOKEN"

      - name: Snyk Monitor (all Maven projects)
        run: snyk monitor --all-projects

      - name: Generate HTML Report (Snyk)
        run: |
          snyk test --all-projects --json | snyk-to-html -o snyk-result.html
          mkdir downloads
          mv snyk-result.html downloads/

      - name: Upload Snyk HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: snyk-report
          path: downloads/snyk-result.html

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=Omnixys_PersonService
            -Dsonar.organization=omnixys
            -Dsonar.host.url=https://sonarcloud.io
            -Dsonar.sources=./src
            -Dsonar.java.binaries=./build
            -Dsonar.branch.name=${{ github.ref_name }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker Scout – Quickview
        id: docker-scout-quickview
        uses: docker/scout-action@v1.15.1
        with:
          command: quickview
          image: calebscript/omnixys-person-service:latest
          summary: false
          write-comment: true

      - name: Save Quickview to File
        run: echo "${{ steps.docker-scout-quickview.outputs.quickview }}" > docker-scout-quickview.md

      - name: Upload Quickview
        uses: actions/upload-artifact@v4
        with:
          name: docker-scout-quickview
          path: docker-scout-quickview.md

      - name: Docker Scout – CVEs
        id: docker-scout-cves
        uses: docker/scout-action@v1.15.1
        with:
          command: cves
          image: calebscript/omnixys-person-service:latest
          summary: false
          write-comment: true

      - name: Save CVEs to File
        run: echo "${{ steps.docker-scout-cves.outputs.cves }}" > docker-scout-cves.md

      - name: Upload CVE Report
        uses: actions/upload-artifact@v4
        with:
          name: docker-scout-cves
          path: docker-scout-cves.md
